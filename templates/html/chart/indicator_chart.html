{% extends 'html/base_indicator.html' %}
{% load static %}
{% block content %}

<div class="chart-header">
  <h2 class="chart-title">График</h2>

  <div class="ws-status-container">
    <div class="ws-status-item">
      <span class="ws-label">Свечи:</span>
      <span id="ws-status-kline" class="ws-dot gray"></span>
      <span id="ws-status-kline-text">—</span>
      <span id="ws-kline-last-update" class="ws-time"></span>
    </div>

    <div class="ws-status-item">
      <span class="ws-label">Сигналы:</span>
      <span id="ws-status-signals" class="ws-dot gray"></span>
      <span id="ws-status-signals-text">—</span>
      <span id="ws-signals-last-update" class="ws-time"></span>
    </div>
  </div>
</div>

<div class="chart-controls">
  <div class="pair-select">
    <label>Пара:</label>
    <select id="pair-select">
      <option value="BTCUSDT" selected>BTC/USDT</option>
    </select>
  </div>

  <div class="interval-select">
    <label>Интервал:</label>
    <select id="interval-select">
      <option value="1" selected>1m</option>
      <option value="5">5m</option>
      <option value="15">15m</option>
      <option value="30">30m</option>
      <option value="60">1h</option>
    </select>
  </div>

  <div class="indicators-select">
    <label>Индикации:</label>
    <button id="open-modal-btn">Открыть настройки</button>
  </div>

  <div class="reset-container">
    <button id="reset-settings">Сбросить настройки</button>
  </div>
</div>

<div class="chart-wrapper">
  <div id="chart-container" class="chart-container"></div>
  <div id="chart-info"></div>
</div>

<!-- === МОДАЛЬНОЕ ОКНО === -->
<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-sidebar">
      <ul>
        <li class="active" data-section="indicators">Индикаторы</li>
        <li data-section="signals">Сигналы</li>
        <li data-section="params">Параметры</li>
      </ul>
    </div>

    <div class="modal-body">
      <div class="section active" id="section-indicators">
        <h3>Индикаторы</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-rsi">
          <span>RSI</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-stochrsi">
          <span>StochRSI</span>
        </label>
      </div>

      <div class="section" id="section-signals">
        <h3>Сигналы</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-buy-signal">
          <span>Показывать сигналы покупки</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-sell-signal">
          <span>Показывать сигналы продажи</span>
        </label>
      </div>

      <div class="section" id="section-params">
        <h3>Параметры отображения</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-positions">
          <span>Показывать позиции</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-orders">
          <span>Показывать ордера</span>
        </label>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script type="module" src="{% static 'js/chart/indicator_chart.js' %}"></script>

<script>
  const modal = document.getElementById('settings-modal');
  const openBtn = document.getElementById('open-modal-btn');
  const resetBtn = document.getElementById('reset-settings');

  openBtn.onclick = () => modal.style.display = 'flex';
  modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

  document.querySelectorAll('.modal-sidebar li').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.modal-sidebar li').forEach(i => i.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      item.classList.add('active');
      document.getElementById(`section-${item.dataset.section}`).classList.add('active');
    });
  });

  const checkboxes = document.querySelectorAll('.modal-body input[type="checkbox"]');
  window.addEventListener('load', () => {
    checkboxes.forEach(chk => {
      const saved = localStorage.getItem(chk.id);
      if (saved !== null) chk.checked = saved === 'true';
    });
  });
  checkboxes.forEach(chk => chk.addEventListener('change', () => {
    localStorage.setItem(chk.id, chk.checked);
  }));
  resetBtn.onclick = () => {
    checkboxes.forEach(chk => { chk.checked = false; localStorage.removeItem(chk.id); });
  };
</script>

{% endblock %}
