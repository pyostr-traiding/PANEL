{% extends 'html/site/base_app.html' %}
{% load static %}

{% block content %}

<div class="chart-header">
  <h2 class="chart-title">График</h2>

  <div class="ws-status-container">
    <div class="ws-status-item">
      <span class="ws-label">Свечи:</span>
      <span id="ws-status-kline" class="ws-dot gray"></span>
      <span id="ws-status-kline-text">—</span>
      <span id="ws-kline-last-update" class="ws-time"></span>
    </div>

    <div class="ws-status-item">
      <span class="ws-label">Сигналы:</span>
      <span id="ws-status-signals" class="ws-dot gray"></span>
      <span id="ws-status-signals-text">—</span>
      <span id="ws-signals-last-update" class="ws-time"></span>
    </div>
  </div>
</div>

<!-- === ГЛАВНЫЙ ЛЕЙАУТ: вкладки слева, фильтры и график справа === -->
<div class="chart-layout">

  <!-- === ВКЛАДКИ (слева) === -->
  <div class="market-tabs">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="orderbook">Книга ордеров</button>
      <button class="tab-btn" data-tab="depth">Глубина рынка</button>
      <button class="tab-btn" data-tab="balances">Балансы</button>
    </div>

    <!-- === КНИГА ОРДЕРОВ === -->
    <div class="tab-content active" id="tab-orderbook">
      <div class="tab-header">
        <div class="tab-title">
          <h3>Книга ордеров</h3>
          <span class="tooltip-icon" data-tooltip="Отображает активные лимитные ордера на покупку и продажу. Зеленые строки — это заявки на покупку (спрос), красные — на продажу (предложение). Используется для оценки ликвидности и ближайших уровней поддержки/сопротивления."></span>
        </div>
        <div class="ws-status-block">
          <div class="ws-indicator" id="ws-status-orderbook"></div>
          <div class="ws-status-text" id="ws-text-orderbook">—</div>
        </div>
      </div>

      <div id="orderbook-wrapper" class="orderbook-wrapper">
        <div class="orderbook">
          <div class="orderbook-side">
            <h4>Покупки (Bids)</h4>
            <table id="orderbook-bids" class="orderbook-table">
              <thead><tr><th>Цена</th><th>Объём</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="orderbook-side">
            <h4>Продажи (Asks)</h4>
            <table id="orderbook-asks" class="orderbook-table">
              <thead><tr><th>Цена</th><th>Объём</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- === ГЛУБИНА РЫНКА === -->
    <div class="tab-content" id="tab-depth">
      <div class="tab-header">
        <div class="tab-title">
          <h3>Глубина рынка</h3>
          <span class="tooltip-icon" data-tooltip="Показывает кумулятивное распределение ордеров на покупку (зелёная зона) и продажу (красная зона). Помогает оценить баланс сил между покупателями и продавцами, а также определить крупные стенки заявок, которые могут повлиять на движение цены."></span>
        </div>
        <div class="ws-status-block">
          <div class="ws-indicator" id="ws-status-depth"></div>
          <div class="ws-status-text" id="ws-text-depth">—</div>
        </div>
      </div>
      <div id="depth-chart" class="depth-chart"></div>
    </div>

    <!-- === БАЛАНСЫ === -->
    <div class="tab-content" id="tab-balances">
      <div class="tab-header">
        <div class="tab-title">
          <h3>Балансы участников</h3>
          <span class="tooltip-icon" data-tooltip="Отображает суммарные позиции условных трейдеров. Позволяет увидеть, кто в данный момент активнее — покупатели или продавцы."></span>
        </div>
        <div class="ws-status-block">
          <div class="ws-indicator" id="ws-status-balances"></div>
          <div class="ws-status-text" id="ws-text-balances">—</div>
        </div>
      </div>
      <div class="balances-wrapper">
        <div id="balances-list" class="balances-list"></div>
      </div>
    </div>
  </div>

  <!-- === ПРАВАЯ ЧАСТЬ (фильтры + график) === -->
  <div class="chart-right">

    <div class="chart-controls">
      <div class="pair-select">
        <label>Пара:</label>
        <select id="pair-select">
          <option value="BTCUSDT" selected>BTC/USDT</option>
        </select>
      </div>

      <div class="interval-select">
        <label>Интервал:</label>
        <select id="interval-select">
          <option value="1" selected>1m</option>
          <option value="5">5m</option>
          <option value="15">15m</option>
          <option value="30">30m</option>
          <option value="60">1h</option>
        </select>
      </div>

      <div class="indicators-select">
        <label>Индикации:</label>
        <button id="open-modal-btn">Открыть настройки</button>
      </div>

      <div class="reset-container">
        <button id="reset-settings">Сбросить настройки</button>
      </div>
    </div>

    <div class="chart-wrapper">
      <div id="chart-container" class="chart-container"></div>
      <div id="chart-info"></div>
    </div>
  </div>
</div>

<!-- === МОДАЛЬНОЕ ОКНО === -->
<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-sidebar">
      <ul>
        <li class="active" data-section="indicators">Индикаторы</li>
        <li data-section="signals">Сигналы</li>
        <li data-section="params">Параметры</li>
      </ul>
    </div>

    <div class="modal-body">
      <div class="section active" id="section-indicators">
        <h3>Индикаторы</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-rsi">
          <span>RSI</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-stochrsi">
          <span>StochRSI</span>
        </label>
      </div>

      <div class="section" id="section-signals">
        <h3>Сигналы</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-buy-signal">
          <span>Показывать сигналы покупки</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-sell-signal">
          <span>Показывать сигналы продажи</span>
        </label>
      </div>

      <div class="section" id="section-params">
        <h3>Параметры отображения</h3>
        <label class="setting-item">
          <input type="checkbox" id="show-positions">
          <span>Показывать позиции</span>
        </label>
        <label class="setting-item">
          <input type="checkbox" id="show-orders">
          <span>Показывать ордера</span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- === СКРИПТЫ === -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="{% static 'js/chart/indicators/orderbook/ws_manager.js' %}"></script>
<script src="{% static 'js/chart/indicators/orderbook/indicator_orderbook.js' %}"></script>
<script src="{% static 'js/chart/indicators/orderbook/indicator_depth.js' %}"></script>
<script src="{% static 'js/chart/indicators/orderbook/indicator_balances.js' %}"></script>
<script type="module" src="{% static 'js/chart/chart.js' %}"></script>

<script>
  // --- Переключение вкладок ---
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
    });
  });

  // --- Модальное окно ---
  const modal = document.getElementById('settings-modal');
  const openModalBtn = document.getElementById('open-modal-btn');

  if (openModalBtn && modal) {
    openModalBtn.addEventListener('click', () => {
      modal.style.display = 'flex';
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });
  }

  // --- Переключение разделов внутри модального окна ---
  const modalTabs = document.querySelectorAll('.modal-sidebar li');
  const modalSections = document.querySelectorAll('.modal-body .section');

  modalTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Сброс активных вкладок
      modalTabs.forEach(t => t.classList.remove('active'));
      modalSections.forEach(s => s.classList.remove('active'));

      // Активируем выбранную
      tab.classList.add('active');
      const target = tab.dataset.section;
      const section = document.getElementById(`section-${target}`);
      if (section) section.classList.add('active');
    });
  });
</script>



{% endblock %}
