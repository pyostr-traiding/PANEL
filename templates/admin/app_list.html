{% load i18n %}

{% if app_list %}
  {% for app in app_list %}
    <div class="app-{{ app.app_label }} module{% if app.app_url in request.path|urlencode %} current-app{% endif %}" data-app="{{ app.app_label }}">
      <table>
        <caption>
          <a href="{{ app.app_url }}" class="section" title="{% blocktranslate with name=app.name %}Models in the {{ name }} application{% endblocktranslate %}">{{ app.name }}</a>
          <button type="button" class="collapse-btn" style="float:right;">&#9660;</button>
        </caption>

        <thead class="visually-hidden">
          <tr>
            <th scope="col">{% translate 'Model name' %}</th>
            <th scope="col">{% translate 'Add link' %}</th>
            <th scope="col">{% translate 'Change or view list link' %}</th>
          </tr>
        </thead>

        <!-- Контейнер для сворачивания -->
        <tbody class="module-body">
        {% for model in app.models %}
          {% with model_name=model.object_name|lower %}
            <tr class="model-{{ model_name }}{% if model.admin_url in request.path|urlencode %} current-model{% endif %}">
              <th scope="row" id="{{ app.app_label }}-{{ model_name }}">
                {% if model.admin_url %}
                  <a href="{{ model.admin_url }}"{% if model.admin_url in request.path|urlencode %} aria-current="page"{% endif %}>{{ model.name }}</a>
                {% else %}
                  {{ model.name }}
                {% endif %}
              </th>

              {% if model.add_url %}
                <td><a href="{{ model.add_url }}" class="addlink">{% translate 'Add' %}</a></td>
              {% else %}
                <td></td>
              {% endif %}

              {% if model.admin_url and show_changelinks %}
                {% if model.view_only %}
                  <td><a href="{{ model.admin_url }}" class="viewlink">{% translate 'View' %}</a></td>
                {% else %}
                  <td><a href="{{ model.admin_url }}" class="changelink">{% translate 'Change' %}</a></td>
                {% endif %}
              {% elif show_changelinks %}
                <td></td>
              {% endif %}
            </tr>
          {% endwith %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
{% else %}
  <p>{% translate 'You don’t have permission to view or edit anything.' %}</p>
{% endif %}

<style>
/* таблица всегда сохраняет ширину */
.module table {
    width: 100%;
    table-layout: fixed;
}

/* скрываем содержимое таблицы при свернутом состоянии */
.module.collapsed .module-body {
    display: none;
}

/* кнопка в caption */
.collapse-btn {
    background: transparent;
    border: none;
    font-size: 12px;
    cursor: pointer;
    margin-left: 5px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modules = document.querySelectorAll('.module');

    modules.forEach(module => {
        const appLabel = module.dataset.app;
        const btn = module.querySelector('.collapse-btn');

        // Восстановим состояние из localStorage
        if(localStorage.getItem('collapsed_' + appLabel) === 'true') {
            module.classList.add('collapsed');
            btn.innerHTML = '&#9654;';
        }

        // Клик по кнопке
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            module.classList.toggle('collapsed');

            // Меняем стрелку
            btn.innerHTML = module.classList.contains('collapsed') ? '&#9654;' : '&#9660;';

            // Сохраняем состояние
            localStorage.setItem('collapsed_' + appLabel, module.classList.contains('collapsed'));
        });
    });
});
</script>
